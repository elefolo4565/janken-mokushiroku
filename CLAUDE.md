# ジャンケン黙示録 (janken_mokushiroku)

## 概要
賭博黙示録カイジの「限定ジャンケン」をモチーフにしたリアルタイム対戦オンラインゲーム。
Among Us風の見下ろし型フィールドで最大20人が移動し、フィールド上の「勝負ゾーン」で対戦する。

## 技術スタック
- **クライアント**: Godot 4.6 (GDScript) → HTML5エクスポート（スマホ縦画面ブラウザ）
- **サーバー**: Node.js (ESM) + Express + ws (WebSocket)
- **デプロイ**: Render.com Web Service 1つ（サーバー + 静的ファイル配信）

## プロジェクト構造
- `scenes/` - Godotシーンファイル (.tscn)
- `scripts/` - GDScript (.gd)
  - `autoload/` - NetworkManager, GameState (シングルトン)
  - `lobby/` - タイトル、ルーム一覧、待機画面
  - `game/` - メインゲーム画面、フィールド、ゾーンダイアログ
  - `result/` - 結果画面
- `server/src/` - Node.jsサーバー
  - `index.js` - Express + WebSocket起動
  - `game-loop.js` - 20tick/secのゲームループ
  - `collision.js` - 衝突検出（交渉接触用）・プレイヤー押し出し処理
  - `janken.js` - じゃんけん判定
  - `battle-zone.js` - 勝負ゾーン管理（BattleZoneManager）
  - `room-manager.js` - ルーム管理
  - `trade.js` - 取引処理（ゴールド対応）
  - `protocol.js` - メッセージ型定義
  - `player-state.js` - プレイヤー状態管理クラス
  - `connection-handler.js` - WebSocket接続ハンドラ
  - `ai-player.js` - AIプレイヤー（ゾーン制対応、性格パラメータで行動が変化）
  - `battle-logger.js` - 対戦ログのファイル出力

## 開発コマンド
- サーバー起動: `cd server && npm run dev`
- サーバー本番: `cd server && npm start`
- ポート: 10000 (WebSocket: ws://localhost:10000/ws)

## アーキテクチャ上の注意点
- **サーバー権威型**: 位置計算・衝突検出・じゃんけん判定は全てサーバー側で実行
- **WebSocketPeer**: Godot 4.6の低レベルWebSocket API使用（高レベルMultiplayer APIは不使用）
- **_process()でpoll()必須**: WebSocketPeerは毎フレームpoll()を呼ぶ必要がある
- **カード内訳は非公開情報**: 各プレイヤーのカード内訳(グー何枚等)は本人にのみ送信。全体カード総数のみ公開
- **ブラウザ実行時はwss://**: HTML5エクスポート時、NetworkManagerが自動的にwss://プロトコルに切り替え
- **Render.comの制限**: 無料プランはアイドル15分でスリープ。wss://で接続必須

## ゲームルール
- 各手のカード枚数・初期星数・勝利条件星数・制限時間はルーム作成時にカスタマイズ可能
- じゃんけん発生時、あいこでも両者のカードは消費される
- 星が0になったら即退場
- カード全消費 + 星が勝利条件以上 + ゴールドが勝利条件以上 → ゴールゲートに入れる

## 勝負ゾーンシステム
- **ゾーン配置**: フィールドをグリッド分割して均等配置。数はルーム設定で変更可能（デフォルト4）
- **マッチング**: ゾーンに2名が入るとマッチング。3人目はゾーンに入れない
- **対戦フロー**: マッチング → 相手情報表示（名前/星/金/カード総数）→ 勝負するか選択 → 手選択+賭け金入力 → 相手待ち → じゃんけん判定
- **賭け金**: 両者がそれぞれ指定し、低い方の金額に合わせる
- **勝負結果**: 勝者は星+1＋賭け金獲得、敗者は星-1＋賭け金喪失。あいこはカード消費のみ
- **ゾーンタイムアウト**: 15秒（設定可能）。タイムアウト時はマッチ自動キャンセル
- **ゾーン状態色**: 空=青薄、1人待ち=黄、マッチ中=赤

## ゴールドシステム
- **新リソース「ゴールド」**: 勝負の賭け金、取引通貨、ゴール条件として機能
- **初期ゴールド**: ルーム設定で変更可能（デフォルト100）
- **勝利条件ゴールド**: ルーム設定で変更可能（デフォルト50）
- **取引**: カード・星に加えてゴールドも交換可能
- **プロトコル**: `YOUR_GOLD` メッセージで個別送信、STATEメッセージにも `yourGold` を含む

## AI対戦機能
- ホストが待機ルームで「AI追加」ボタンを押してAIプレイヤーを追加可能（最大20人まで）
- AIは全てサーバー側で動作（WebSocket接続なし、`send()`はno-op）
- AI性格パラメータ: `aggression`（攻撃性）、`caution`（慎重さ）、`smartness`（賢さ）がランダムで決定
- AI行動: ゾーンを選択して移動 → マッチング時に性格パラメータに基づいて勝負判断 → 手選択・賭け金決定
- AIはカードがなくなり勝利条件を満たしたらゴールゲートへ向かう

## UI構成
- **入力**: VirtualJoystick（`scripts/game/virtual_joystick.gd`）がメインUI層で入力を処理し、`GameState.input_vector`経由でGameFieldに伝達
  - タッチ/マウスドラッグ + WASD/矢印キー対応
  - 画面左下に半透明円形で固定表示
- **交渉ボタン**: 画面右下にトグルボタンとして配置。接触方式の取引を有効化
- **ゾーンダイアログ**: マッチング時にモーダル表示。相手情報→手選択+賭け金→待機の3段階UI
- **対戦ログ**: BattleLog（`scripts/game/battle_log.gd`）が画面上部に右からスライドインで表示、最大5行
- **カメラ**: プレイヤー中心に常時追従（クランプなし）
- **情報バー**: 上部にカード総数、残り時間、自分の星・ゴールド・カード内訳を表示

## 実装上の注意点
- **SubViewport座標問題**: GameFieldはSubViewport内にあるため、マウス座標とスクリーンタッチ座標の座標空間が異なる。入力処理はSubViewport外のVirtualJoystickで行い座標問題を回避
- **ゾーン離脱時のクリーンアップ**: ゾーンマッチ中のプレイヤーが退場/切断した場合、相手にZONE_CANCELLEDを送信しゾーン状態をリセットする必要がある
